name: Scala CI

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    # Java 8 (required for Play 2.3.x and sbt 0.13.x)
    - name: Set up Java 8
      uses: actions/setup-java@v3
      with:
        java-version: '8'
        distribution: 'temurin'

    # Install sbt deb package
    - name: Install sbt
      run: |
        echo "Adding sbt repository..."
        echo "deb [signed-by=/usr/share/keyrings/sbt-keyring.gpg] https://repo.scala-sbt.org/scalasbt/debian all main" \
          | sudo tee /etc/apt/sources.list.d/sbt.list

        echo "Importing sbt GPG key..."
        curl -sL "https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x99E82A75642AC823" \
          | gpg --dearmor | sudo tee /usr/share/keyrings/sbt-keyring.gpg > /dev/null

        sudo apt-get update
        sudo apt-get install -y sbt

    # CRITICAL: Add old Typesafe repositories so sbt 0.13 can resolve plugins
    - name: Add historical Typesafe repositories
      run: |
        mkdir -p ~/.sbt
        echo "Configuring ~/.sbt/repositories ..."
        cat > ~/.sbt/repositories << 'EOF'
[repositories]
local
typesafe-ivy-releases: https://repo.typesafe.com/typesafe/ivy-releases/, [ivy]
typesafe-releases: https://repo.typesafe.com/typesafe/releases/
maven-central: https://repo1.maven.org/maven2/
EOF

    # Validate sbt installation
    - name: Verify sbt
      run: sbt sbt-version

    # Build the Play project
    - name: Build Play application
      run: sbt clean dist
