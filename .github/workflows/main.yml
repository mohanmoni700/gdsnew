name: Scala CI

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
  

permissions:
  contents: read

jobs:
  build:

    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Set up JDK 8
      uses: actions/setup-java@v3
      with:
        java-version: '8'
        distribution: 'temurin'
        cache: 'sbt'
    - name: Clear sbt / ivy / coursier caches (safe)
      run: |
          set -euo pipefail
          rm -rf ~/.sbt/boot ~/.sbt/launchers ~/.ivy2/cache ~/.coursier || true
          rm -rf project/target project/project/target project/boot || true

    - name: Force sbt 0.13.17 for CI (override project build.properties)
      run: |
          set -euo pipefail
          # If your build.sbt is in a subfolder, change REL_PATH accordingly (default '.')
          REL_PATH="."
          mkdir -p "$REL_PATH/project"
          echo "sbt.version=0.13.17" > "$REL_PATH/project/build.properties"
          echo "CI override: $REL_PATH/project/build.properties:"
          cat "$REL_PATH/project/build.properties"

    - name: Install sbt-extras launcher (validated)
      run: |
          set -euo pipefail
          curl -fsSL https://raw.githubusercontent.com/paulp/sbt-extras/master/sbt -o sbt
          if head -n1 sbt | grep -iqE '^#!'; then
            chmod +x sbt
            sudo mv sbt /usr/local/bin/sbt
          else
            echo "sbt-extras download invalid; aborting"
            head -n 40 sbt || true
            exit 1
          fi
          echo "/usr/local/bin/sbt head:"
          head -n 3 /usr/local/bin/sbt
          /usr/local/bin/sbt --version || true

    - name: Verify & run sbt dist
      working-directory: ${{ github.workspace }}  # or path to your project if not repo root
      run: |
          set -euo pipefail
          echo "project/build.properties (effective):"
          cat project/build.properties || true
          echo "Running sbt about..."
          sbt -no-colors about
          echo "Running sbt dist..."
          sbt -no-colors dist

